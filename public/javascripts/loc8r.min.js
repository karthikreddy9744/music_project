!function(){"use strict";angular.module("loc8rApp",["ngRoute"]).config(["$routeProvider","$locationProvider",function(e,t){t.hashPrefix(""),e.when("/",{templateUrl:"views/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/admin/add",{templateUrl:"views/admin-add.html",controller:"adminCtrl",controllerAs:"vm",resolve:{adminCheck:["authService","$location",function(e,t){e.isAdmin()||t.path("/")}]}}).when("/home",{templateUrl:"views/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"views/signin.html",controller:"signinCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"views/register.html",controller:"registerCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"views/about.html",controller:"aboutCtrl",controllerAs:"vm"}).when("/profile",{templateUrl:"views/profile.html",controller:"profileCtrl",controllerAs:"vm"}).when("/profile/edit",{templateUrl:"views/profile-edit.html",controller:"profileEditCtrl",controllerAs:"vm"}).when("/location/add",{templateUrl:"views/location-form.html",controller:"locationFormCtrl",controllerAs:"vm",resolve:{adminCheck:["authService","$location",function(e,t){e.isAdmin()||t.path("/")}]}}).when("/location/:locationid",{templateUrl:"views/location-detail.html",controller:"locationDetailCtrl",controllerAs:"vm"}).when("/location/:locationid/edit",{templateUrl:"views/location-form.html",controller:"locationFormCtrl",controllerAs:"vm",resolve:{adminCheck:["authService","$location",function(e,t){e.isAdmin()||t.path("/")}]}}).when("/location/:locationid/review/add",{templateUrl:"views/review-form.html",controller:"reviewFormCtrl",controllerAs:"vm"}).when("/location/:locationid/review/:reviewid/edit",{templateUrl:"views/review-form.html",controller:"reviewFormCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"})}])}(),function(){"use strict";function e(e){return{request:function(t){var o=e.getToken();return o&&(t.headers=t.headers||{},t.headers.Authorization="Bearer "+o),t}}}angular.module("loc8rApp").factory("authInterceptor",e).config(["$httpProvider",function(e){e.interceptors.push("authInterceptor")}]),e.$inject=["authService"]}(),function(){"use strict";function e(e){var t=e.localStorage,o="loc8r_token";this.saveToken=function(e){e?t.setItem(o,e):t.removeItem(o)},this.getToken=function(){return t.getItem(o)},this.logout=function(){t.removeItem(o)},this.parseToken=function(){var e=this.getToken();if(!e)return null;try{var t=e.split(".")[1];return t=t.replace(/-/g,"+").replace(/_/g,"/"),t=decodeURIComponent(atob(t).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join("")),JSON.parse(t)}catch(e){return null}},this.getRole=function(){var e=this.parseToken();return e&&e.role?e.role:null},this.isAdmin=function(){return"admin"===this.getRole()},this.isAuthenticated=function(){return!!this.getToken()}}angular.module("loc8rApp").service("authService",e),e.$inject=["$window"]}(),function(){"use strict";angular.module("loc8rApp").service("loc8rData",["$http","$q",function(e,t){var o="/api";this.getLocations=function(){return e.get(o+"/locations").catch(function(){return e.get("/data/locations.json")})},this.getLocationById=function(t){return e.get(o+"/locations/"+t).catch(function(){return e.get("/data/locations.json").then(function(e){return{data:e.data.find(e=>e._id===t)}})})},this.addLocation=function(r){return e.post(o+"/locations",r).catch(function(){return t.resolve({data:r})})},this.updateLocation=function(r,n){return e.put(o+"/locations/"+r,n).catch(function(){return t.resolve({data:n})})},this.deleteLocation=function(r){return e.delete(o+"/locations/"+r).catch(function(){return t.resolve({})})},this.addReview=function(r,n){return e.post(o+"/locations/"+r+"/reviews",n).catch(function(){return t.resolve({data:n})})},this.getReview=function(r,n){return e.get(o+"/locations/"+r+"/reviews/"+n).catch(function(){return t.reject({message:"Review not found (mock)"})})},this.updateReview=function(r,n,a){return e.put(o+"/locations/"+r+"/reviews/"+n,a).catch(function(){return t.resolve({data:a})})},this.deleteReview=function(r,n){return e.delete(o+"/locations/"+r+"/reviews/"+n).catch(function(){return t.resolve({})})},this.getLocationsByCoords=function(t,r,n){return e.get(o+"/locations",{params:{lat:t,lng:r,maxDistance:n}}).catch(function(){return e.get("/data/locations.json").then(function(e){return{data:(e.data||[]).filter(function(e){if(!e.coords||!Array.isArray(e.coords.coordinates))return!1;var o=e.coords.coordinates[0],a=e.coords.coordinates[1];return 111e3*Math.sqrt(Math.pow(a-t,2)+Math.pow(o-r,2))<=n})}})})},this.getNearbyRestaurants=function(t,r,n){return e.get(o+"/locations/nearby",{params:{lat:t,lng:r,maxDistance:n}}).catch(function(){return e.get("/data/locations.json").then(function(e){var o=Array.isArray(e.data)?e.data:e.data.locations||[];if(!o)return{data:[]};return{data:o.map(function(e){var o=e.coords&&e.coords.coordinates?e.coords.coordinates:e.coordinates&&e.coordinates.coordinates?e.coordinates.coordinates:e.location&&e.location.coordinates?e.location.coordinates:null;if(!o)return null;var n=(o[1]-t)*Math.PI/180,a=(o[0]-r)*Math.PI/180,i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(t*Math.PI/180)*Math.cos(o[1]*Math.PI/180)*Math.sin(a/2)*Math.sin(a/2),c=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return e.distance=6371*c*1e3,e}).filter(Boolean).filter(function(e){return e.distance<=n})}})})}}])}(),function(){"use strict";angular.module("loc8rApp").service("userData",["$http","$window",function(e,t){const o="/api";this.getProfile=function(){return e.get(o+"/profile",{headers:{Authorization:"Bearer "+t.localStorage.getItem("token")},cache:!1})},this.updateProfile=function(r){return e.put(o+"/profile",r,{headers:{Authorization:"Bearer "+t.localStorage.getItem("token")}})},this.getUserReviews=function(){return e.get(o+"/profile/reviews",{headers:{Authorization:"Bearer "+t.localStorage.getItem("token")},cache:!1})},this.uploadAvatar=function(r){const n=new FormData;return n.append("avatar",r),e.post(o+"/profile/avatar",n,{headers:{Authorization:"Bearer "+t.localStorage.getItem("token"),"Content-Type":void 0},transformRequest:angular.identity})}}])}(),angular.module("loc8rApp").directive("fileModel",["$parse",function(e){return{restrict:"A",link:function(t,o,r){var n=e(r.fileModel).assign;o.bind("change",function(){t.$apply(function(){n(t,o[0].files[0])})})}}}]),function(){"use strict";angular.module("loc8rApp").directive("leafletMap",["$timeout",function(e){return{restrict:"E",scope:{vmCtrl:"=",locations:"="},template:'<div class="map-container" style="width:100%; height:100%; min-height:300px;"></div>',link:function(e,t){var o=t[0].children[0],r=null,n=null,a=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",iconSize:[32,32],iconAnchor:[16,32]}),i=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/149/149059.png",iconSize:[32,32],iconAnchor:[16,32]}),c=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",iconSize:[40,40],iconAnchor:[20,40],className:"marker-highlight"});function s(t,s,l){var u;if(r?n.clearLayers():(u=[t,s],r=L.map(o).setView(u,13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(r),n=L.layerGroup().addTo(r)),t&&s&&L.marker([t,s],{icon:a}).bindPopup("You are here").addTo(n),l&&l.length&&l.forEach(e=>{var t=e.coords?.coordinates||e.coordinates?.coordinates||e.location?.coordinates;if(t){var o=L.marker([t[1],t[0]],{icon:i}).bindPopup("<b>"+(e.name||"")+"</b><br>"+(e.address||""));o.on("click",function(){n.eachLayer(e=>{e.setIcon&&e.setIcon(i),e.closePopup&&e.closePopup()}),o.setIcon(c),o.openPopup()}),o.addTo(n),e._marker=o}}),e.vmCtrl){var d=e.vmCtrl.location||null,h=d?.coords?.coordinates?d.coords.coordinates[1]:e.vmCtrl.lat||t,f=d?.coords?.coordinates?d.coords.coordinates[0]:e.vmCtrl.lng||s;if(h&&f&&d){var g=L.marker([h,f],{draggable:!0,icon:a}).addTo(n).bindPopup("Drag to set location");g.on("dragend",function(){var t=g.getLatLng();d.coords={type:"Point",coordinates:[t.lng,t.lat]},e.$apply()}),e.vmCtrl._marker=g,r.setView([h,f],13)}}}e.$watchGroup(["vmCtrl","locations"],function(e){var t=e[0],o=e[1]||[],r=t?.location?.coords?.coordinates?t.location.coords.coordinates[1]:t?.lat,n=t?.location?.coords?.coordinates?t.location.coords.coordinates[0]:t?.lng;r&&n&&s(r,n,o)},!0),e.$on("map:updateMarkers",function(e,t){t.userLocation&&t.restaurants&&s(t.userLocation.lat,t.userLocation.lng,t.restaurants)})}}}])}(),function(){"use strict";angular.module("loc8rApp").controller("aboutCtrl",[function(){this.pageHeader={title:"About Loc8r"},this.content="Loc8r is a demo app that lists places with wifi. This is a small single page AngularJS app used for teaching and prototyping."}])}(),function(){"use strict";angular.module("loc8rApp").controller("adminCtrl",["$http","authService",function(e,t){var o=this;o.username="",o.password="",o.message="",o.error="",o.loading=!1,o.addAdmin=function(){o.message=o.error="",o.username&&o.password?(o.loading=!0,e.post("/api/admin/add",{username:o.username,password:o.password}).then(function(e){o.loading=!1,o.message=e.data.message||"Admin created successfully",o.username=o.password=""}).catch(function(e){o.loading=!1,o.error=e.data&&e.data.message||"Error adding admin",console.error("Add admin error:",e)})):o.error="Username and password are required"}}])}(),function(){"use strict";angular.module("loc8rApp").controller("homeCtrl",["$scope","loc8rData",function(e,t){var o=this;o.distance=5e3,o.locations=[],o.message="",o.lat=null,o.lng=null;var r=io();o.requestNearby=function(){o.lat&&o.lng&&r.emit("getNearby",{lng:o.lng,lat:o.lat,maxDistance:parseInt(o.distance,10)})},o.focusOn=function(e){e&&e._marker&&o._map&&(o._map.eachLayer(function(e){e.closePopup&&e.closePopup()}),o._map.flyTo(e._marker.getLatLng(),16,{duration:1.2}),e._marker.openPopup(),o._highlightedMarker&&o._highlightedMarker!==e._marker&&o._highlightedMarker.setIcon(o._restaurantIcon),e._marker.setIcon(o._highlightIcon),o._highlightedMarker=e._marker)},r.on("connect",function(){e.$applyAsync(()=>{o.message=""})}),r.on("nearbyResults",function(t){e.$applyAsync(function(){o.locations=Array.isArray(t)?t:[],o.message=o.locations.length?"":"No restaurants found",e.$broadcast("map:updateMarkers",{userLocation:{lat:o.lat,lng:o.lng},restaurants:o.locations})})}),r.on("errorMsg",function(t){e.$applyAsync(function(){o.message=t&&t.error||"Failed to fetch nearby restaurants"})}),e.$watch(()=>o.distance,function(e,t){e!==t&&(e<1e3&&(o.distance=1e3),e>25e4&&(o.distance=25e4),r.connected&&o.requestNearby())}),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(n){e.$apply(function(){o.lat=n.coords.latitude,o.lng=n.coords.longitude,r.connected?o.requestNearby():t.getNearbyRestaurants(o.lat,o.lng,o.distance).then(t=>{o.locations=t.data||[],e.$broadcast("map:updateMarkers",{userLocation:{lat:o.lat,lng:o.lng},restaurants:o.locations})}).catch(()=>o.message="Unable to fetch nearby restaurants")})},function(){o.message="Enable GPS and allow location permission"},{enableHighAccuracy:!0}):o.message="Geolocation not supported"}])}(),function(){"use strict";angular.module("loc8rApp").controller("locationDetailCtrl",["$routeParams","loc8rData",function(e,t){var o=this;o.locationid=e.locationid,o.location=null,o.message="",o.formError="",o.getLocation=function(){t.getLocationById(o.locationid).then(function(e){o.location=e.data}).catch(function(e){o.message="Sorry, something went wrong",console.error(e)})},o.addReview=function(){o.newReview&&o.newReview.author&&o.newReview.rating&&o.newReview.reviewText?(o.formError="",t.submitReview(o.locationid,o.newReview).then(function(){o.newReview={},o.getLocation()}).catch(function(e){o.formError="Sorry, something went wrong",console.error(e)})):o.formError="All fields required"},o.deleteReview=function(e){confirm("Are you sure you want to delete this review?")&&t.deleteReview(o.locationid,e).then(function(){o.getLocation()}).catch(function(e){o.message="Error deleting review",console.error(e)})},o.getLocation()}])}(),function(){"use strict";angular.module("loc8rApp").controller("locationFormCtrl",["$routeParams","loc8rData","$location",function(e,t,o){var r=this;r.isEdit=!!e.locationid,r.location={name:"",address:"",facilities:"",rating:0,coords:{type:"Point",coordinates:[78.486671,17.385044]},openingTimes:[]},r.message="",r.isEdit&&t.getLocationById(e.locationid).then(function(e){r.location=e.data,r.location.coords&&Array.isArray(r.location.coords.coordinates)&&2===r.location.coords.coordinates.length||(r.location.coords={type:"Point",coordinates:[78.486671,17.385044]}),Array.isArray(r.location.openingTimes)||(r.location.openingTimes=[])}).catch(function(e){r.message="Error loading location",console.error(e)}),r.addOpeningTime=function(){r.location.openingTimes.push({days:"",opening:"",closing:"",closed:!1})},r.removeOpeningTime=function(e){r.location.openingTimes.splice(e,1)},r.saveLocation=function(){if(!r.location.name||!r.location.address)return void(r.message="Name and Address are required");if(!r.location.coords||!Array.isArray(r.location.coords.coordinates)||2!==r.location.coords.coordinates.length)return void(r.message="Please select a location on the map");const n=parseFloat(r.location.coords.coordinates[0]),a=parseFloat(r.location.coords.coordinates[1]);if(isNaN(a)||isNaN(n))return void(r.message="Invalid coordinates. Please pin the location on the map.");const i=Array.isArray(r.location.facilities)?r.location.facilities.join(","):r.location.facilities||"",c=Array.isArray(r.location.openingTimes)?r.location.openingTimes:[],s={name:r.location.name,address:r.location.address,rating:r.location.rating||0,facilities:i,lat:a,lng:n,openingTimes:c};(r.isEdit?t.updateLocation(e.locationid,s):t.addLocation(s)).then(()=>{o.path("/")}).catch(e=>{r.message="Error saving location",console.error(e)})}}])}(),function(){"use strict";function e(e,t){var o=this;o.isAuthenticated=function(){return e.isAuthenticated()},o.isAdmin=function(){return e.isAdmin()},o.logout=function(){e.logout(),t.path("/signin")},o.username=function(){var t=e.parseToken();return t&&t.username?t.username:null}}angular.module("loc8rApp").controller("navCtrl",e),e.$inject=["authService","$location"]}(),angular.module("loc8rApp").controller("profileCtrl",["userData","$location",function(e,t){var o=this;o.user={},o.message="",o.reviews=[],e.getProfile().then(function(e){o.user=e.data,o.avatarPreview=o.user.avatar||"/images/default-avatar.png"}).catch(function(e){console.error(e)}),e.getUserReviews().then(function(e){o.reviews=e.data}).catch(function(e){console.error(e)}),o.goToUpdateProfile=function(){t.path("/profile/edit")},o.deleteReview=function(e,t){confirm("Are you sure you want to delete this review?")&&$http.delete("/api/locations/"+e+"/reviews/"+t,{headers:{Authorization:"Bearer "+localStorage.getItem("token")}}).then(function(){o.reviews=o.reviews.filter(e=>e.reviewId!==t),alert("Review deleted successfully")}).catch(function(e){console.error(e),alert("Error deleting review")})}}]),angular.module("loc8rApp").controller("profileEditCtrl",["userData","$scope",function(e,t){var o=this;o.user={},o.avatarPreview="/images/default-avatar.png",o.avatarFile=null,o.message="",e.getProfile().then(function(e){Object.assign(o.user,e.data),o.avatarPreview=o.user.avatar&&o.user.avatar.data?`data:${o.user.avatar.contentType};base64,${o.user.avatar.data}`:"/images/default-avatar.png"}).catch(function(e){console.error(e)}),o.previewAvatar=function(e){if(e.files&&e.files[0]){o.avatarFile=e.files[0];var r=new FileReader;r.onload=function(e){t.$apply(function(){o.avatarPreview=e.target.result})},r.readAsDataURL(e.files[0])}},o.updateAvatar=function(){if(!o.avatarFile)return alert("Please select an image!");e.uploadAvatar(o.avatarFile).then(function(e){o.message=e.data.message,o.avatarPreview=e.data.user.avatar&&e.data.user.avatar.data?`data:${e.data.user.avatar.contentType};base64,${e.data.user.avatar.data}`:"/images/default-avatar.png",o.avatarFile=null}).catch(function(e){console.error(e)})},o.updateProfile=function(){e.updateProfile(o.user).then(function(e){o.message=e.data.message}).catch(function(e){console.error(e)})},o.goToProfile=function(){window.location.href="#!/profile"}}]),function(){"use strict";function e(e,t,o){var r=this;r.user={},r.error=null,r.message=null,r.loading=!1,r.register=function(){r.error=r.message=null,r.user.username&&r.user.password?(r.loading=!0,r.user.role="user",e.post("/api/register",r.user).then(function(e){if(r.loading=!1,e.data&&e.data.token)return o.saveToken(e.data.token),void t.path("/");r.message=e.data&&e.data.message?e.data.message:"Registration successful. Please sign in.",r.user={}}).catch(function(e){r.loading=!1,r.error=e.data&&e.data.message||"Registration failed",console.error("Register error",e)})):r.error="Username and password are required."}}angular.module("loc8rApp").controller("registerCtrl",e),e.$inject=["$http","$location","authService"]}(),function(){"use strict";angular.module("loc8rApp").controller("reviewFormCtrl",["$routeParams","$location","loc8rData",function(e,t,o){var r=this;r.locationid=e.locationid,r.reviewid=e.reviewid,r.review={},r.formError="",r.reviewid&&o.getReview(r.locationid,r.reviewid).then(function(e){r.review.rating=e.data.rating,r.review.reviewText=e.data.reviewText}).catch(function(e){r.formError="Error fetching review"}),r.saveReview=function(){r.review.rating&&r.review.reviewText?r.reviewid?o.updateReview(r.locationid,r.reviewid,r.review).then(function(e){t.path("/location/"+r.locationid)}).catch(function(e){r.formError="Error updating review"}):o.addReview(r.locationid,r.review).then(function(e){t.path("/location/"+r.locationid)}).catch(function(e){r.formError="Error adding review"}):r.formError="All fields are required"}}])}(),function(){"use strict";function e(e,t,o){var r=this;r.user={},r.error=null,r.login=function(){r.error=null,e.post("/api/login",r.user).then(function(e){e.data&&e.data.token?(o.saveToken(e.data.token),t.path("/")):r.error="No token received"}).catch(function(e){r.error=e.data&&e.data.message||"Login failed"})}}angular.module("loc8rApp").controller("signinCtrl",e),e.$inject=["$http","$location","authService"]}();